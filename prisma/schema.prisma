generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String                    @id @default(cuid())
  email                   String                    @unique
  password                String?
  roleId                  String
  venueId                 String?
  active                  Boolean                   @default(true)
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  deletedAt               DateTime?                 // Soft delete - null means not deleted
  bio                     String?
  dateOfBirth             DateTime?
  firstName               String?
  lastName                String?
  phone                   String?
  profileCompletedAt      DateTime?
  profileImage            String?
  aiQueries               AIQuery[]
  auditLogs               AuditLog[]
  availability            Availability[]
  comments                Comment[]
  conversations           ConversationParticipant[]
  sentMessages            Message[]
  notificationPreferences NotificationPreference[]
  notifications           Notification[]
  postReads               PostRead[]
  posts                   Post[]
  reactions               Reaction[]
  reviewedTimeOff         TimeOffRequest[]          @relation("ReviewedBy")
  timeOffRequests         TimeOffRequest[]
  grantedPermissions      UserVenuePermission[]     @relation("GrantedPermissions")
  venuePermissions        UserVenuePermission[]     @relation("UserPermissions")
  venues                  UserVenue[]
  // NEW: Channel relations
  createdChannels         Channel[]                 @relation("CreatedChannels")
  channelMemberships      ChannelMember[]           @relation("ChannelMemberships")
  addedMembers            ChannelMember[]           @relation("AddedChannelMembers")
  role                    Role                      @relation(fields: [roleId], references: [id])
  venue                   Venue?                    @relation(fields: [venueId], references: [id])

  @@index([email])
  @@index([firstName])
  @@index([lastName])
  @@index([roleId])
  @@index([venueId])
  @@index([deletedAt])
  @@map("users")
}

model Role {
  id                     String                  @id @default(cuid())
  name                   String                  @unique
  description            String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  conditionalPermissions ConditionalPermission[] @relation("RoleConditionalPermissions")
  fieldPermissions       FieldPermission[]       @relation("RoleFieldPermissions")
  rolePermissions        RolePermission[]
  timeBasedAccess        TimeBasedAccess[]       @relation("RoleTimeBasedAccess")
  users                  User[]

  @@map("roles")
}

model Permission {
  id                   String                @id @default(cuid())
  resource             String
  action               String
  description          String?
  createdAt            DateTime              @default(now())
  rolePermissions      RolePermission[]
  userVenuePermissions UserVenuePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserVenuePermission {
  id            String     @id @default(cuid())
  userId        String
  venueId       String
  permissionId  String
  grantedAt     DateTime   @default(now())
  grantedBy     String
  grantedByUser User       @relation("GrantedPermissions", fields: [grantedBy], references: [id])
  permission    Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user          User       @relation("UserPermissions", fields: [userId], references: [id], onDelete: Cascade)
  venue         Venue      @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([userId, venueId, permissionId])
  @@index([userId])
  @@index([venueId])
  @@index([permissionId])
  @@index([grantedBy])
  @@map("user_venue_permissions")
}

model Venue {
  id                   String                @id @default(cuid())
  name                 String
  code                 String                @unique
  active               Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  // Business Hours - NEW
  businessHoursStart   String                @default("08:00") // HH:mm format
  businessHoursEnd     String                @default("22:00") // HH:mm format
  operatingDays        Json                  @default("[1,2,3,4,5]") // Array of 0-6 (Sunday-Saturday), default Mon-Fri
  channelVenues        ChannelVenue[]
  userVenuePermissions UserVenuePermission[]
  userVenues           UserVenue[]
  users                User[]

  @@map("venues")
}

model UserVenue {
  id        String   @id @default(cuid())
  userId    String
  venueId   String
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  venue     Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([userId, venueId])
  @@index([userId])
  @@index([venueId])
  @@index([isPrimary])
  @@map("user_venues")
}

model Availability {
  id          String   @id @default(cuid())
  userId      String
  dayOfWeek   Int
  startTime   String?
  endTime     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isAllDay    Boolean  @default(false)
  isAvailable Boolean  @default(false)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek])
  @@index([userId])
  @@index([dayOfWeek])
  @@map("availability")
}

model TimeOffRequest {
  id         String    @id @default(cuid())
  userId     String
  startDate  DateTime
  endDate    DateTime
  type       String
  reason     String?
  status     String    @default("PENDING")
  reviewedBy String?
  reviewedAt DateTime?
  notes      String?
  version    Int       @default(0) // Optimistic locking - NEW
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  reviewer   User?     @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startDate, endDate])
  @@index([status])
  @@index([reviewedBy])
  @@index([type])
  @@map("time_off_requests")
}

model Channel {
  id          String           @id @default(cuid())
  name        String           @unique
  type        String
  permissions Json?            // Changed from String? to Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  archived    Boolean          @default(false)
  archivedAt  DateTime?
  color       String?
  description String?
  icon        String?
  // NEW FIELDS
  createdBy   String?          // User ID of creator (nullable for migration, will be required later)
  memberCount Int              @default(0) // Denormalized for performance
  // Relations
  creator     User?            @relation("CreatedChannels", fields: [createdBy], references: [id])
  members     ChannelMember[]  // NEW: Direct member tracking
  venues      ChannelVenue[]   // Keep for migration compatibility
  posts       Post[]

  @@index([createdBy])
  @@index([memberCount])
  @@map("channels")
}

model ChannelVenue {
  id        String   @id @default(cuid())
  channelId String
  venueId   String
  createdAt DateTime @default(now())
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  venue     Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([channelId, venueId])
  @@index([channelId])
  @@index([venueId])
  @@map("channel_venues")
}

model ChannelMember {
  id        String   @id @default(cuid())
  channelId String
  userId    String
  role      String   @default("MEMBER") // CREATOR, MODERATOR, MEMBER
  // Audit fields
  addedBy   String   // User ID who added this member
  addedAt   DateTime @default(now())
  addedVia  String?  // "manual", "role_based", "venue_based", "bulk_import"
  // Relations
  channel     Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user        User    @relation("ChannelMemberships", fields: [userId], references: [id], onDelete: Cascade)
  addedByUser User    @relation("AddedChannelMembers", fields: [addedBy], references: [id])

  @@unique([channelId, userId])
  @@index([channelId])
  @@index([userId])
  @@index([addedBy])
  @@map("channel_members")
}

model Post {
  id        String     @id @default(cuid())
  channelId String
  authorId  String
  content   String
  mediaUrls String?
  pinned    Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?  // Soft delete - null means not deleted
  edited    Boolean    @default(false)
  editedAt  DateTime?
  comments  Comment[]
  reads     PostRead[]
  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  channel   Channel    @relation(fields: [channelId], references: [id], onDelete: Cascade)
  reactions Reaction[]

  @@index([channelId])
  @@index([authorId])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("posts")
}

model Comment {
  id        String     @id @default(cuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?  // Soft delete - null means not deleted
  edited    Boolean    @default(false)
  editedAt  DateTime?
  parentId  String?
  parent    Comment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]  @relation("CommentReplies")
  post      Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactions Reaction[]

  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@index([deletedAt])
  @@map("comments")
}

model Reaction {
  id        String   @id @default(cuid())
  postId    String?
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, emoji])
  @@unique([commentId, userId, emoji])
  @@index([postId])
  @@index([commentId])
  @@map("reactions")
}

model PostRead {
  id     String   @id @default(cuid())
  userId String
  postId String
  readAt DateTime @default(now())
  post   Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("post_reads")
}

model Conversation {
  id            String                    @id @default(cuid())
  type          String
  lastMessageAt DateTime?
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  lastMessage   String?
  name          String?
  participants  ConversationParticipant[]
  messages      Message[]

  @@index([lastMessageAt])
  @@index([type])
  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime?
  mutedUntil     DateTime?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  mediaUrls      String?
  reactions      String?
  readBy         String[]     @default([])
  updatedAt      DateTime     @updatedAt
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  link      String?
  readAt    DateTime?
  createdAt DateTime         @default(now())
  type      NotificationType
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([readAt])
  @@index([createdAt])
  @@index([type])
  @@index([userId, type])
  @@map("notifications")
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String
  actionType   String
  resourceType String
  resourceId   String?
  oldValue     String?
  newValue     String?
  ipAddress    String?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([actionType])
  @@index([resourceType])
  @@index([resourceType, resourceId])
  @@map("audit_logs")
}

model FieldPermission {
  id        String   @id @default(cuid())
  roleId    String
  resource  String
  field     String
  access    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role      Role     @relation("RoleFieldPermissions", fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, resource, field])
  @@index([roleId])
  @@index([resource])
  @@index([field])
  @@map("field_permissions")
}

model ConditionalPermission {
  id         String   @id @default(cuid())
  roleId     String
  resource   String
  action     String
  conditions Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  role       Role     @relation("RoleConditionalPermissions", fields: [roleId], references: [id], onDelete: Cascade)

  @@index([roleId])
  @@index([resource])
  @@index([action])
  @@map("conditional_permissions")
}

model TimeBasedAccess {
  id         String   @id @default(cuid())
  roleId     String
  resource   String
  action     String
  daysOfWeek Int[]
  startTime  String
  endTime    String
  timezone   String   @default("UTC")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  role       Role     @relation("RoleTimeBasedAccess", fields: [roleId], references: [id], onDelete: Cascade)

  @@index([roleId])
  @@index([resource])
  @@index([action])
  @@map("time_based_access")
}

model NotificationPreference {
  id        String                @id @default(cuid())
  userId    String
  type      NotificationType
  channels  NotificationChannel[]
  enabled   Boolean               @default(true)
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  user      User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type])
  @@index([userId])
  @@index([type])
  @@map("notification_preferences")
}

enum NotificationType {
  NEW_MESSAGE
  MESSAGE_REPLY
  MESSAGE_MENTION
  MESSAGE_REACTION
  POST_MENTION
  POST_PINNED
  POST_DELETED
  TIME_OFF_REQUEST
  TIME_OFF_APPROVED
  TIME_OFF_REJECTED
  TIME_OFF_CANCELLED
  USER_CREATED
  USER_UPDATED
  ROLE_CHANGED
  SYSTEM_ANNOUNCEMENT
  GROUP_REMOVED
}

enum NotificationChannel {
  IN_APP
  EMAIL
  PUSH
  SMS
}

model AvailabilitySnapshot {
  id             String   @id @default(cuid())
  venueId        String?
  snapshotDate   DateTime
  totalStaff     Int
  availableStaff Int
  coverage       Json
  createdAt      DateTime @default(now())

  @@index([venueId, snapshotDate])
  @@map("availability_snapshots")
}

model ReportCache {
  id         String   @id @default(cuid())
  reportType String
  filters    Json
  data       Json
  createdAt  DateTime @default(now())
  expiresAt  DateTime

  @@index([reportType, expiresAt])
  @@map("report_cache")
}

model AIQuery {
  id        String   @id @default(cuid())
  userId    String
  query     String
  response  Json
  filters   Json
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("ai_queries")
}
