generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                 String                    @id @default(cuid())
  email              String                    @unique
  password           String?
  roleId             String
  storeId            String?
  active             Boolean                   @default(true)
  createdAt          DateTime                  @default(now())
  updatedAt          DateTime                  @updatedAt
  bio                String?
  dateOfBirth        DateTime?
  firstName          String?
  lastName           String?
  phone              String?
  profileCompletedAt DateTime?
  profileImage       String?
  auditLogs          AuditLog[]
  availability       Availability[]
  comments           Comment[]
  conversations      ConversationParticipant[]
  sentMessages       Message[]
  notifications      Notification[]
  postReads          PostRead[]
  posts              Post[]
  reactions          Reaction[]
  reviewedTimeOff    TimeOffRequest[]          @relation("ReviewedBy")
  timeOffRequests    TimeOffRequest[]
  grantedPermissions UserVenuePermission[]     @relation("GrantedPermissions")
  venuePermissions   UserVenuePermission[]     @relation("UserPermissions")
  venues             UserVenue[]
  role               Role                      @relation(fields: [roleId], references: [id])
  store              Store?                    @relation(fields: [storeId], references: [id])

  @@index([email])
  @@index([firstName])
  @@index([lastName])
  @@index([roleId])
  @@index([storeId])
  @@map("users")
}

model Role {
  id                     String                  @id @default(cuid())
  name                   String                  @unique
  description            String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  conditionalPermissions ConditionalPermission[] @relation("RoleConditionalPermissions")
  fieldPermissions       FieldPermission[]       @relation("RoleFieldPermissions")
  rolePermissions        RolePermission[]
  timeBasedAccess        TimeBasedAccess[]       @relation("RoleTimeBasedAccess")
  users                  User[]

  @@map("roles")
}

model Permission {
  id                   String                @id @default(cuid())
  resource             String
  action               String
  description          String?
  createdAt            DateTime              @default(now())
  rolePermissions      RolePermission[]
  userVenuePermissions UserVenuePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime   @default(now())
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model UserVenuePermission {
  id            String     @id @default(cuid())
  userId        String
  venueId       String
  permissionId  String
  grantedAt     DateTime   @default(now())
  grantedBy     String
  grantedByUser User       @relation("GrantedPermissions", fields: [grantedBy], references: [id])
  permission    Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user          User       @relation("UserPermissions", fields: [userId], references: [id], onDelete: Cascade)
  venue         Store      @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([userId, venueId, permissionId])
  @@index([userId])
  @@index([venueId])
  @@index([permissionId])
  @@index([grantedBy])
  @@map("user_venue_permissions")
}

model Store {
  id                   String                @id @default(cuid())
  name                 String
  code                 String                @unique
  active               Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  channelVenues        ChannelVenue[]
  userVenuePermissions UserVenuePermission[]
  userVenues           UserVenue[]
  users                User[]

  @@map("stores")
}

model UserVenue {
  id        String   @id @default(cuid())
  userId    String
  venueId   String
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  venue     Store    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([userId, venueId])
  @@index([userId])
  @@index([venueId])
  @@index([isPrimary])
  @@map("user_venues")
}

model Availability {
  id          String   @id @default(cuid())
  userId      String
  dayOfWeek   Int
  startTime   String?
  endTime     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isAllDay    Boolean  @default(false)
  isAvailable Boolean  @default(false)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dayOfWeek])
  @@index([userId])
  @@index([dayOfWeek])
  @@map("availability")
}

model TimeOffRequest {
  id         String    @id @default(cuid())
  userId     String
  startDate  DateTime
  endDate    DateTime
  type       String
  reason     String?
  status     String    @default("PENDING")
  reviewedBy String?
  reviewedAt DateTime?
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  reviewer   User?     @relation("ReviewedBy", fields: [reviewedBy], references: [id])
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startDate, endDate])
  @@index([status])
  @@map("time_off_requests")
}

model Channel {
  id          String         @id @default(cuid())
  name        String         @unique
  type        String
  permissions String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  archived    Boolean        @default(false)
  archivedAt  DateTime?
  color       String?
  description String?
  icon        String?
  venues      ChannelVenue[]
  posts       Post[]

  @@map("channels")
}

model ChannelVenue {
  id        String   @id @default(cuid())
  channelId String
  venueId   String
  createdAt DateTime @default(now())
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  venue     Store    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  @@unique([channelId, venueId])
  @@index([channelId])
  @@index([venueId])
  @@map("channel_venues")
}

model Post {
  id        String     @id @default(cuid())
  channelId String
  authorId  String
  content   String
  mediaUrls String?
  pinned    Boolean    @default(false)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  edited    Boolean    @default(false)
  editedAt  DateTime?
  comments  Comment[]
  reads     PostRead[]
  author    User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
  channel   Channel    @relation(fields: [channelId], references: [id], onDelete: Cascade)
  reactions Reaction[]

  @@index([channelId])
  @@index([authorId])
  @@index([createdAt])
  @@map("posts")
}

model Comment {
  id        String     @id @default(cuid())
  postId    String
  userId    String
  content   String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  edited    Boolean    @default(false)
  editedAt  DateTime?
  parentId  String?
  parent    Comment?   @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]  @relation("CommentReplies")
  post      Post       @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactions Reaction[]

  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@map("comments")
}

model Reaction {
  id        String   @id @default(cuid())
  postId    String?
  userId    String
  emoji     String
  createdAt DateTime @default(now())
  commentId String?
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, emoji])
  @@unique([commentId, userId, emoji])
  @@index([postId])
  @@index([commentId])
  @@map("reactions")
}

model PostRead {
  id     String   @id @default(cuid())
  userId String
  postId String
  readAt DateTime @default(now())
  post   Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("post_reads")
}

model Conversation {
  id            String                    @id @default(cuid())
  type          String
  lastMessageAt DateTime?
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  lastMessage   String?
  name          String?
  participants  ConversationParticipant[]
  messages      Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id             String       @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())
  lastReadAt     DateTime?
  mutedUntil     DateTime?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
  @@map("conversation_participants")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  readAt         DateTime?
  createdAt      DateTime     @default(now())
  mediaUrls      String?
  reactions      String?
  readBy         String[]     @default([])
  updatedAt      DateTime     @updatedAt
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  link      String?
  readAt    DateTime?
  createdAt DateTime         @default(now())
  type      NotificationType
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([readAt])
  @@index([createdAt])
  @@map("notifications")
}

model AuditLog {
  id           String   @id @default(cuid())
  userId       String
  actionType   String
  resourceType String
  resourceId   String?
  oldValue     String?
  newValue     String?
  ipAddress    String?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([actionType])
  @@map("audit_logs")
}

model FieldPermission {
  id        String   @id @default(cuid())
  roleId    String
  resource  String
  field     String
  access    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  role      Role     @relation("RoleFieldPermissions", fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, resource, field])
  @@index([roleId])
  @@index([resource])
  @@index([field])
  @@map("field_permissions")
}

model ConditionalPermission {
  id         String   @id @default(cuid())
  roleId     String
  resource   String
  action     String
  conditions Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  role       Role     @relation("RoleConditionalPermissions", fields: [roleId], references: [id], onDelete: Cascade)

  @@index([roleId])
  @@index([resource])
  @@index([action])
  @@map("conditional_permissions")
}

model TimeBasedAccess {
  id         String   @id @default(cuid())
  roleId     String
  resource   String
  action     String
  daysOfWeek Int[]
  startTime  String
  endTime    String
  timezone   String   @default("UTC")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  role       Role     @relation("RoleTimeBasedAccess", fields: [roleId], references: [id], onDelete: Cascade)

  @@index([roleId])
  @@index([resource])
  @@index([action])
  @@map("time_based_access")
}

enum NotificationType {
  NEW_MESSAGE
  MESSAGE_REPLY
  MESSAGE_MENTION
  MESSAGE_REACTION
  POST_MENTION
  POST_PINNED
  POST_DELETED
  TIME_OFF_REQUEST
  TIME_OFF_APPROVED
  TIME_OFF_REJECTED
  TIME_OFF_CANCELLED
  USER_CREATED
  USER_UPDATED
  ROLE_CHANGED
  SYSTEM_ANNOUNCEMENT
  GROUP_REMOVED
}
